#!/bin/bash
# ÙÙˆØ±ÛŒ: Ø¨Ù„Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨ÛŒØ±ÙˆÙ†ÛŒ Ø¨Ù‡ Redis
# Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯: sudo bash security-fix-urgent.sh

echo "ğŸš¨ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ ÙÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Redis..."

# 1. Ø¨Ù„Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÙˆØ±Øª 6379 Ø§Ø² Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨ÛŒØ±ÙˆÙ†ÛŒ
echo "ğŸ“ Ø¨Ù„Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÙˆØ±Øª 6379..."
sudo iptables -I DOCKER-USER -p tcp --dport 6379 -j DROP

# 2. Ø¨Ø±Ø±Ø³ÛŒ Ù‚ÙˆØ§Ù†ÛŒÙ† ÙØ§ÛŒØ±ÙˆØ§Ù„
echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù‚ÙˆØ§Ù†ÛŒÙ† ÙØ§ÛŒØ±ÙˆØ§Ù„..."
sudo iptables -L DOCKER-USER -n --line-numbers | grep 6379

# 3. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§
echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§..."
ss -tulnp | grep 6379 || echo "Ù¾ÙˆØ±Øª 6379 Ø¨Ø³ØªÙ‡ Ø§Ø³Øª âœ…"

# 4. Ù†ØµØ¨ iptables-persistent Ø¨Ø±Ø§ÛŒ Ø­ÙØ¸ Ù‚ÙˆØ§Ù†ÛŒÙ†
echo "ğŸ“¦ Ù†ØµØ¨ iptables-persistent..."
sudo apt update && sudo apt install -y iptables-persistent

# 5. Ø°Ø®ÛŒØ±Ù‡ Ù‚ÙˆØ§Ù†ÛŒÙ† ÙØ§ÛŒØ±ÙˆØ§Ù„
echo "ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù‚ÙˆØ§Ù†ÛŒÙ† ÙØ§ÛŒØ±ÙˆØ§Ù„..."
sudo netfilter-persistent save

echo "âœ… Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ ÙÙˆØ±ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!"
echo "âš ï¸  ØªÙˆØ¬Ù‡: Redis Ù‡Ù…Ú†Ù†Ø§Ù† Ø¨Ø¯ÙˆÙ† Ù¾Ø³ÙˆØ±Ø¯ Ø§Ø³Øª - Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª Ú©Ø§Ù…Ù„ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ docker-compose Ø±Ø§ Ø§ØµÙ„Ø§Ø­ Ú©Ù†ÛŒØ¯"
